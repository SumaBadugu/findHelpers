<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Available Services</title>
  <style>
    /* Your existing CSS for userServicesPage.html */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f8fa;
      margin: 0;
      color: rgb(63, 63, 63);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
   
    
    header {
      background-color: #21778f;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
    }

   
    main {
      flex: 1; 
      max-width: 900px;
      margin: 40px auto;
      padding: 0 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 700;
      color: #18126d;
    }

    /* Search Bar */
    .search-bar {
      max-width: 400px;
      margin: 0 auto 40px;
      display: flex;
      gap: 10px;
    }
    .search-bar input {
      flex: 1;
      padding: 10px 15px;
      font-size: 1rem;
      border: 2px solid black;
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s ease;
    }
    .search-bar input:focus {
      border-color: #2b6e79;
    }

    
    .services-container {
      display: flex;
      flex-wrap: wrap;
      gap: 25px;
      justify-content: center;
    }
    .service-card {
      background-color: white;
      width: 220px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 25px 20px;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .service-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .service-icon {
      font-size: 50px;
      margin-bottom: 15px;
    }
    .service-name {
      font-weight: 700;
      font-size: 1.15rem;
      margin-bottom: 8px;
      color: #222;
    }
    .book-btn {
      background-color: #1b5e6a;
      color: white;
      border: none;
      padding: 10px 0;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .book-btn:hover {
      background-color: #2b6e79;
    }

    
    #professionalsContainer {
        margin-top: 40px;
        text-align: center;
    }
    #professionalsContainer h2 {
        color: #1b5e6a;
        margin-bottom: 20px;
    }
    #professionalsContainer .pro-card {
        background: white;
        padding: 20px;
        margin: 10px auto; 
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        max-width: 400px; 
        text-align: left;
    }
    #professionalsContainer .pro-card button {
        background:#1b5e6a; 
        color:white; 
        border:none; 
        padding:8px 12px; 
        border-radius:8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    #professionalsContainer .pro-card button:hover {
        background-color: #2b6e79;
    }


    
    footer {
      background-color: #21778f;
      color: white;
      padding: 15px ;
      text-align: center;
      font-size: 0.9rem;
      margin-top: auto; 
    }

    
    .popup{
      display: none;
      z-index : 9999;
      background-color: white;
      position:fixed; 
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      background:white;
      padding:20px;
      box-shadow:0 5px 20px rgba(0,0,0,0.2);
      border-radius:10px; 
      max-width: 400px;
      width: 90%;
    }
    .popup h3, .popup p {
        text-align: center;
        margin-bottom: 15px;
    }
    .popup #selectedProfessionalName {
        font-weight: bold;
        color: #21778f;
    }
    .popup input.request{
      width:calc(100% - 20px);
      margin:10px 10px;
      padding:8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .popup button {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
    }
    .popup button.send-btn {
        background:#1b5e6a; 
        color:white;
        margin-left: calc(50% - 100px); 
    }
    .popup button.cancel-btn {
        margin-left:10px; 
        background:#ccc;
        color: #333;
    }
    .popup button.send-btn:hover {
        background-color: #2b6e79;
    }
    .popup button.cancel-btn:hover {
        background-color: #bbb;
    }


    
    @media (max-width: 600px) {
      .services-container {
        flex-direction: column;
        align-items: center;
      }
      .service-card {
        width: 90%;
      }
      .search-bar {
        max-width: 100%;
      }
      #professionalsContainer .pro-card {
          width: 90%;
      }
      .popup button.send-btn {
          margin-left: 0;
          width: calc(50% - 5px); 
          margin-bottom: 10px;
      }
      .popup button.cancel-btn {
          margin-left: 10px;
          width: calc(50% - 15px);
      }
    }
  </style>
</head>
<body>

<header>
  FIND HELPERS
</header>

<main>
  <h1>Available Services</h1>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search services..." oninput="filterServices()" />
  </div>

  <div class="services-container" id="servicesContainer">
    <!-- Service cards will be loaded here by JavaScript -->
    <p>Loading services...</p>
  </div>
  
  <div id="professionalsContainer">
    <!-- Service professionals will be displayed here by JavaScript -->
  </div>

<!-- Request Popup -->
<div id="popup" class="popup">
  <h3>Send Request</h3>
  <p id="selectedProfessionalName"></p>
  
  <!-- Hidden inputs to store IDs -->
  <input type="hidden" id="user_id_popup"/> 
  <input type="hidden" id="sp_id_popup"/>
  <input type="hidden" id="ser_id_popup"/>

  <input type="text" placeholder="Your Name" class="request" id="req_user_name_popup" required/>
  <input type="tel" placeholder="Mobile number" class="request" id="contact_popup" required/>
  <input type="date" placeholder="Enter date" class="request" id="serviceDate_popup" required/>
  <input type="time" placeholder="Enter time" class="request" id="serviceTime_popup" required/>
  <input type="text" placeholder="Your Address" class="request" id="address_popup" required/>
  <button onclick="sendRequest()" class="send-btn">Send</button>
  <button onclick="closePopup()" class="cancel-btn">Cancel</button>
</div>

</main>

<footer>
  &copy; 2025 Find Helpers.
</footer>

<script>
  // --- Initialization and User Authentication ---
  const loggedInUserId = localStorage.getItem('loggedInUserId');
  const loggedInUserName = localStorage.getItem('loggedInUserName');

  if (!loggedInUserId) {
      alert('You are not logged in. Please log in to book services.');
      window.location.href = 'login.html';
  } else {
      document.getElementById('req_user_name_popup').value = loggedInUserName || '';
      document.getElementById('user_id_popup').value = loggedInUserId;
  }
  
  let services = []; // Stores all fetched services
  let serviceProfessionals = []; // Stores professionals for a selected service

  // --- Service Icons Mapping  ---
  const serviceIcons= {
    "Plumbing Repair" : "üîß",
    "Home Cleaning" : "üßπ",
    "Electrical Work" : "üí°",
    "AC Service" : "‚ùÑÔ∏è",
    "Gardening" : "üåø",
    "Painting" : "üé®",
    "Other" : "üë∑" 
  };

  // --- Fetching Services from API ---
  async function loadServices(){
    try{
      const res = await fetch('https://findhelpers.onrender.com/services');
      if (!res.ok) {
          throw new Error(`Failed to fetch services: ${res.statusText}`);
      }
      const data = await res.json();
      services = data;
      renderServices(services);
    }
    catch(err){
      console.error("Error in fetching services:", err);
      servicesContainer.innerHTML = `<p style="text-align: center; width: 100%; color: red;">Failed to load services. ${err.message || 'Please try again.'}</p>`;
      
    }
  }

  // --- Rendering Services on Page ---
  const servicesContainer = document.getElementById("servicesContainer");
  const searchInput = document.getElementById("searchInput");

  function renderServices(filteredServices) {
    servicesContainer.innerHTML = ""; // Clear previous services
    if (filteredServices.length === 0) {
        servicesContainer.innerHTML = "<p style='text-align: center; width: 100%;'>No services found matching your search.</p>";
        return;
    }
    filteredServices.forEach(service => {
      // Ensure service.serviceName is precisely matched with keys in serviceIcons
      const icon = serviceIcons[service.servicename] || serviceIcons["Other"]; 
      const card = document.createElement("div");
      card.className = "service-card";
      card.innerHTML = `
        <div class="service-icon" aria-label="${service.servicename} icon">${icon}</div>
        <div class="service-name">${service.servicename}</div>
        <button class="book-btn" onclick="bookService(${service.ser_id})">Book</button>
      `;
      servicesContainer.appendChild(card);
    });
  }

  // --- Filtering Services via Search Input ---
  function filterServices() {
    const query = searchInput.value.toLowerCase();
    const filtered = services.filter(s => s.servicename.toLowerCase().includes(query));
    renderServices(filtered);
  }

  // --- Booking a Service (fetching professionals for that service) ---
  async function bookService(serviceId) {
    console.log("Booking service with ID:", serviceId);
    const selectedService = services.find(s => s.ser_id === serviceId);
    if (!selectedService) {
        alert("Service not found.");
        return;
    }
    const selectedServiceName = selectedService.servicename; 

    try{
        const resp = await fetch(`https://findhelpers.onrender.com/serviceProfessionals/${serviceId}`);
        if (!resp.ok) {
            throw new Error(`Failed to fetch service professionals: ${resp.statusText}`);
        }
        serviceProfessionals = await resp.json();
        showProfessionals(selectedServiceName, serviceId); 
    }
    catch(err){
        console.error("Error in fetching service professionals:", err);
        document.getElementById("professionalsContainer").innerHTML = `<p style="color: red;">Failed to load professionals for this service. ${err.message || 'Please try again.'}</p>`;
        // alert("Failed to load professionals for this service."); // Removed redundant alert
    }
  }

  // --- Displaying Available Professionals ---
  function showProfessionals(servicename, serviceId) {
  const container = document.getElementById("professionalsContainer");
  container.innerHTML = `<h2>Available Professionals for ${servicename}</h2>`;
  
  if (serviceProfessionals.length === 0) {
      container.innerHTML += "<p>No professionals available for this service yet.</p>";
      return;
  }

  serviceProfessionals.forEach(pro => {
    const proCard = document.createElement("div");
    proCard.className = "pro-card"; 
    proCard.innerHTML = `
      <strong>${pro.sp_name}</strong><br/>
      Area: ${pro.sp_area}<br/>
      Contact: ${pro.sp_contact}<br/><br/>
      <button onclick="openPopup('${encodeURIComponent(JSON.stringify(pro))}', ${serviceId})">Send Request</button>
    `;
    container.appendChild(proCard);
  });
}

// --- Managing Request Popup ---
function openPopup(proStr, serviceId) {
  const pro = JSON.parse(decodeURIComponent(proStr));
  document.getElementById("popup").style.display = "block";
  
  document.getElementById("selectedProfessionalName").innerText = `To: ${pro.sp_name}`;
  
  document.getElementById("sp_id_popup").value = pro.sp_id;
  document.getElementById("ser_id_popup").value = serviceId;
  
  // Set min date to today for serviceDate_popup
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0'); 
  const dd = String(today.getDate()).padStart(2, '0');
  document.getElementById('serviceDate_popup').min = `${yyyy}-${mm}-${dd}`;
}

function closePopup() {
  document.getElementById("popup").style.display = "none";
  // Clear form fields in popup, reset name to logged-in user's name
  document.getElementById('req_user_name_popup').value = loggedInUserName || ''; 
  document.getElementById('contact_popup').value = '';
  document.getElementById('serviceDate_popup').value = '';
  document.getElementById('serviceTime_popup').value = '';
  document.getElementById('address_popup').value = '';
}

// --- Sending the Service Request ---
async function sendRequest() {
  const reqUserName = document.getElementById('req_user_name_popup').value;
  const contact = document.getElementById('contact_popup').value;
  const serviceDate = document.getElementById('serviceDate_popup').value;
  const serviceTime = document.getElementById('serviceTime_popup').value;
  const address = document.getElementById('address_popup').value;

  // Basic client-side validation
  if (!reqUserName || !contact || !serviceDate || !serviceTime || !address) {
      alert("Please fill in all the request details.");
      return;
  }

  const requestData = {
    user_id : document.getElementById("user_id_popup").value,
    sp_id : document.getElementById("sp_id_popup").value,
    ser_id : document.getElementById("ser_id_popup").value,
    req_user_name: reqUserName,
    contact: contact,
    serviceDate: serviceDate,
    serviceTime: serviceTime,
    address: address,
  };

  console.log("Sending request data:", requestData); 

  try {
    const res = await fetch('https://findhelpers.onrender.com/requests',{
      method : "POST",
      headers : {
        "Content-Type" : "application/json"
      },
      body: JSON.stringify(requestData)
    });

    if (!res.ok) {
        const errorText = await res.text();
        alert("Failed to send request: " + errorText);
        throw new Error(errorText);
    }
    
    const message = await res.text();
    alert(message);
    closePopup(); // Close on success
  } catch (err) {
    console.error("Error sending request:", err);
    alert(`An error occurred while sending your request: ${err.message}`); // Inform user of error
  }
}

  // --- Initial Load ---
  document.addEventListener('DOMContentLoaded', loadServices); // Load services when the DOM is ready
</script>

</body>
</html>